using UnityEngine;
using System.Collections.Generic;

public class AdManager : MonoBehaviour
{
    [SerializeField] private AdData[] allAds;
    [SerializeField] private GameObject adWindowPrefab;
    [SerializeField] private Transform uiParent;

    private List<AdData> availableAds = new List<AdData>();

    void Start()
    {
        // ?????????????? ?????? ????????? ??????
        availableAds = new List<AdData>(allAds);
    }

    public void ShowRandomAd()
    {
        if (availableAds.Count == 0)
        {
            Debug.LogWarning("??? ????????? ???????!");
            return;
        }

        // ???????? ????????? ??????? ? ?????? ?????
        AdData randomAd = GetRandomAdWithWeight();

        // ??????? ???? ???????
        GameObject adWindow = Instantiate(adWindowPrefab, uiParent);
        AdWindowController adController = adWindow.GetComponent<AdWindowController>();

        if (adController != null)
        {
            adController.SetupAd(randomAd);
        }

        // ??????? ?????????? ??????? ?? ????????? (???????????)
        availableAds.Remove(randomAd);

        // ???? ??? ??????? ????????, ??????????????? ??????
        if (availableAds.Count == 0)
        {
            availableAds = new List<AdData>(allAds);
        }
    }

    private AdData GetRandomAdWithWeight()
    {
        float totalWeight = 0f;

        foreach (AdData ad in availableAds)
        {
            totalWeight += ad.weight;
        }

        float randomValue = Random.Range(0f, totalWeight);

        foreach (AdData ad in availableAds)
        {
            if (randomValue < ad.weight)
            {
                return ad;
            }
            randomValue -= ad.weight;
        }

        return availableAds[0];
    }
}